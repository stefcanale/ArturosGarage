<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arturo's Garage English</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0fdf4; }
        .mechanic-gradient { background: linear-gradient(135deg, #065f46 0%, #1e40af 100%); }
        .message-anim { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-slate-50">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        
        const { useState, useRef, useEffect } = React;
        const { createRoot } = ReactDOM;

        const SYSTEM_PROMPT = `
            You are "Gearhead", a friendly English tutor for mechanics.
            1. Use car metaphors for grammar.
            2. Correct mistakes with a "Diagnostics Report".
            3. Keep it short.
        `;

        const IconWrench = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>;
        const IconKey = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 7a2 2 0 0 1 2 2m4 0a6 6 0 0 1-7.743 5.743L11 17H9v2H7v2H4a1 1 0 0 1-1-1v-2.586a1 1 0 0 1 .293-.707l5.964-5.964A6 6 0 1 1 21 9z"/></svg>;
        const IconSend = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>;

        const App = () => {
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
            const [showKeyInput, setShowKeyInput] = useState(!localStorage.getItem('gemini_api_key'));
            const [tempKey, setTempKey] = useState('');
            const [messages, setMessages] = useState([
                { role: 'model', text: "Hey! I'm Gearhead. ðŸ› ï¸ Ready to verify your English engine? We can talk diagnostics or parts!" }
            ]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const messagesEndRef = useRef(null);

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

            const handleSaveKey = () => {
                if (tempKey.trim()) {
                    localStorage.setItem('gemini_api_key', tempKey);
                    setApiKey(tempKey);
                    setShowKeyInput(false);
                }
            };

            const generateResponse = async (userText) => {
                if (!apiKey) {
                    setMessages(prev => [...prev, { role: 'model', text: "I need an API Key to start! Click the key icon." }]);
                    return;
                }
                setLoading(true);
                try {
                    const genAI = new GoogleGenerativeAI(apiKey);
                    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                    const chat = model.startChat({
                        history: [
                            { role: "user", parts: [{ text: SYSTEM_PROMPT }] },
                            { role: "model", parts: [{ text: "Ready." }] },
                            ...messages.map(m => ({ role: m.role === 'user' ? 'user' : 'model', parts: [{ text: m.text }] }))
                        ]
                    });
                    const result = await chat.sendMessage(userText);
                    setMessages(prev => [...prev, { role: 'model', text: result.response.text() }]);
                } catch (error) {
                    setMessages(prev => [...prev, { role: 'model', text: "Connection Error. Check your API Key." }]);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="flex flex-col h-full relative">
                    {showKeyInput && (
                        <div className="absolute inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
                                <h2 className="text-xl font-bold mb-4 flex items-center gap-2">Setup Required</h2>
                                <input type="password" placeholder="Paste Gemini API Key here..." className="w-full p-3 border rounded-lg mb-4" value={tempKey} onChange={(e) => setTempKey(e.target.value)} />
                                <button onClick={handleSaveKey} className="w-full py-3 bg-emerald-600 text-white rounded-lg font-bold">Start Engine</button>
                            </div>
                        </div>
                    )}

                    <header className="mechanic-gradient text-white p-4 shadow-lg flex justify-between items-center z-10">
                        <div className="flex items-center gap-3">
                            <div className="bg-white/20 p-2 rounded-lg"><IconWrench /></div>
                            <h1 className="font-bold text-lg">Arturo's Garage</h1>
                        </div>
                        <button onClick={() => setShowKeyInput(true)} className="p-2 hover:bg-white/10 rounded-full"><IconKey /></button>
                    </header>

                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {messages.map((msg, idx) => (
                            <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} message-anim`}>
                                <div className={`max-w-[85%] rounded-2xl p-4 shadow-sm ${msg.role === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white border text-gray-800 rounded-bl-none'}`}>
                                    {msg.text}
                                </div>
                            </div>
                        ))}
                        {loading && <div className="text-gray-400 text-sm p-4">Thinking...</div>}
                        <div ref={messagesEndRef} />
                    </div>

                    <div className="p-4 bg-white border-t">
                        <form onSubmit={(e) => { e.preventDefault(); if(input.trim()) { const t = input; setInput(''); setMessages(p => [...p, {role:'user', text: t}]); generateResponse(t); }}} className="flex gap-2 max-w-4xl mx-auto">
                            <input type="text" value={input} onChange={(e) => setInput(e.target.value)} placeholder="Type here..." className="flex-1 bg-gray-100 rounded-xl px-4 py-3 outline-none" />
                            <button type="submit" disabled={loading} className="bg-blue-600 text-white p-3 rounded-xl"><IconSend /></button>
                        </form>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
