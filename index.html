<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arturo's Garage - Voice Mode</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #ecfdf5; }
        /* Animaci√≥n suave para cuando habla */
        .pulse-ring {
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            animation: pulse-green 2s infinite cubic-bezier(0.66, 0, 0, 1);
        }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div id="root" class="w-full"></div>

    <script type="text/babel" data-type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- TU CONFIGURACI√ìN ---
        const SYSTEM_PROMPT = `
            You are "Arturo", a friendly mechanic helping with English. 
            Keep answers short and conversational (1-2 sentences). 
            Correct grammar gently if needed.
        `;

        const App = () => {
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
            const [showKey, setShowKey] = useState(!localStorage.getItem('gemini_api_key'));
            const [tempKey, setTempKey] = useState('');
            
            // Estados de la conversaci√≥n
            const [isListening, setIsListening] = useState(false);
            const [isThinking, setIsThinking] = useState(false);
            const [transcript, setTranscript] = useState("Tap the green button to start talking...");
            const [history, setHistory] = useState([
                { role: 'model', parts: [{ text: "Hi! I'm Arturo. Ready to practice?" }] }
            ]);

            const recognitionRef = useRef(null);

            // Guardar API Key
            const handleSaveKey = () => {
                if(tempKey) { localStorage.setItem('gemini_api_key', tempKey); setApiKey(tempKey); setShowKey(false); }
            };

            // Funci√≥n para hablar (Text to Speech)
            const speak = (text) => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            };

            // Funci√≥n para enviar a Gemini
            const sendToGemini = async (text) => {
                setIsThinking(true);
                try {
                    const genAI = new GoogleGenerativeAI(apiKey);
                    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                    
                    const chat = model.startChat({
                        history: [
                            { role: "user", parts: [{ text: SYSTEM_PROMPT }] },
                            { role: "model", parts: [{ text: "Ok, I'm ready." }] },
                            ...history
                        ]
                    });

                    const result = await chat.sendMessage(text);
                    const response = result.response.text();
                    
                    setHistory(prev => [...prev, { role: 'user', parts: [{ text }] }, { role: 'model', parts: [{ text: response }] }]);
                    setTranscript(response);
                    speak(response); // Arturo habla
                } catch (error) {
                    setTranscript("Error: Check API Key connection.");
                }
                setIsThinking(false);
            };

            // Configurar micr√≥fono
            const toggleMic = () => {
                if (!apiKey) { setShowKey(true); return; }
                
                if (isListening) {
                    recognitionRef.current?.stop();
                    setIsListening(false);
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) { alert("Use Chrome/Safari"); return; }

                const recognition = new SpeechRecognition();
                recognition.lang = 'en-US';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = () => { setIsListening(true); setTranscript("Listening..."); };
                recognition.onend = () => setIsListening(false);
                recognition.onresult = (event) => {
                    const text = event.results[0][0].transcript;
                    setTranscript(`You said: "${text}"`);
                    sendToGemini(text);
                };

                recognitionRef.current = recognition;
                recognition.start();
            };

            return (
                <div className="w-full max-w-lg mx-auto flex flex-col gap-6">
                    
                    {/* Modal API Key */}
                    {showKey && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-xl">
                                <h3 className="font-bold text-lg mb-2">Setup Key</h3>
                                <input type="password" className="w-full border p-3 rounded-lg mb-4" placeholder="Gemini API Key" value={tempKey} onChange={e=>setTempKey(e.target.value)} />
                                <button onClick={handleSaveKey} className="w-full bg-emerald-600 text-white py-3 rounded-lg font-bold">Save & Start</button>
                            </div>
                        </div>
                    )}

                    {/* Header */}
                    <div className="flex items-center gap-4 px-2">
                        <div className="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center text-2xl shadow-sm border border-emerald-200">
                            üë®‚Äçüîß
                        </div>
                        <div>
                            <h1 className="text-2xl font-black text-gray-800 tracking-tight">Arturo's Garage</h1>
                            <p className="text-emerald-600 font-medium text-sm">Your English mechanic friend</p>
                        </div>
                        <button onClick={() => setShowKey(true)} className="ml-auto text-gray-400">üîë</button>
                    </div>

                    {/* Main Card (Action) */}
                    <div className="bg-white rounded-3xl p-6 shadow-xl border border-emerald-50 text-center">
                        <h2 className="text-xl font-bold text-gray-800 mb-2">Ready to talk?</h2>
                        <p className="text-gray-500 mb-6 text-sm">Arturo is in his workshop, ready for a chat.</p>
                        
                        <button 
                            onClick={toggleMic}
                            className={`w-full py-6 rounded-2xl font-bold text-lg transition-all flex items-center justify-center gap-3 shadow-lg ${
                                isListening 
                                ? 'bg-red-500 text-white pulse-ring' 
                                : isThinking
                                    ? 'bg-gray-100 text-gray-400 cursor-wait'
                                    : 'bg-emerald-500 hover:bg-emerald-600 text-white hover:-translate-y-1'
                            }`}
                        >
                            {isListening ? (
                                <><span>üõë</span> Stop Listening</>
                            ) : isThinking ? (
                                <><span>‚öôÔ∏è</span> Thinking...</>
                            ) : (
                                <><span>üéôÔ∏è</span> Start Conversation</>
                            )}
                        </button>
                    </div>

                    {/* Helper Card (Transcript) */}
                    <div className="bg-white rounded-3xl p-6 shadow-lg border border-emerald-50 min-h
